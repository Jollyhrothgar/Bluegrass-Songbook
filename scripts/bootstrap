#!/usr/bin/env bash
#
# bootstrap - First-time setup and build
#
# Usage:
#   ./scripts/bootstrap              # Full setup: install deps + build index
#   ./scripts/bootstrap --quick      # Skip dependency install, just build index
#   ./scripts/bootstrap --enrich     # Run enrichment step (usually not needed)
#

set -e

SECONDS=0  # Track elapsed time
STAGE_START=0
DEPS_TIME=0
ENRICH_TIME=0
BUILD_TIME=0

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
cd "$REPO_ROOT"

QUICK=false
DO_ENRICH=false
for arg in "$@"; do
    case $arg in
        --quick)
            QUICK=true
            shift
            ;;
        --enrich)
            DO_ENRICH=true
            shift
            ;;
        # Legacy flag for backward compatibility
        --skip-enrich)
            shift
            ;;
    esac
done

echo "=== Bluegrass Songbook Bootstrap ==="
echo ""

# Install dependencies (unless --quick)
if [ "$QUICK" = false ]; then
    STAGE_START=$SECONDS
    echo "Installing dependencies..."
    uv sync
    DEPS_TIME=$((SECONDS - STAGE_START))
    echo ""
fi

# Enrich songs (add provenance) - only if explicitly requested
if [ "$DO_ENRICH" = true ]; then
    STAGE_START=$SECONDS
    echo "Enriching songs..."
    uv run python3 scripts/lib/enrich_songs.py
    ENRICH_TIME=$((SECONDS - STAGE_START))
    echo ""
fi

# Build search index from works/ (with tag enrichment for grassiness + covering artists)
STAGE_START=$SECONDS
echo "Building search index..."
uv run python3 scripts/lib/build_works_index.py
BUILD_TIME=$((SECONDS - STAGE_START))

echo ""
echo "Bootstrap complete! (${SECONDS}s total)"
echo "  Timing breakdown:"
[ "$QUICK" = false ] && echo "    - Dependencies: ${DEPS_TIME}s"
[ "$DO_ENRICH" = true ] && echo "    - Enrichment: ${ENRICH_TIME}s"
echo "    - Build index: ${BUILD_TIME}s"
echo ""
echo "  - Run './scripts/server' to start the frontend"
echo "  - Visit http://localhost:8080"
