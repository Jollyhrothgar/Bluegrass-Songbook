#!/usr/bin/env bash
#
# utility - User-facing utility commands
#
# Usage:
#   ./scripts/utility add-song /path/to/song.pro [--skip-index-rebuild]
#   ./scripts/utility count-chords [path]
#

set -e

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
cd "$REPO_ROOT"

COMMAND="${1:-}"
shift 2>/dev/null || true

show_help() {
    echo "Usage: ./scripts/utility <command> [options]"
    echo ""
    echo "Commands:"
    echo "  add-song <file.pro> [--skip-index-rebuild]"
    echo "      Add a song to the manual collection and rebuild the index"
    echo ""
    echo "  add-placeholder <title> [--artist NAME] [--key KEY] [--tags TAG,TAG] [--notes TEXT]"
    echo "      Create a placeholder work with metadata but no content"
    echo ""
    echo "  count-chords [path]"
    echo "      Count chord usage in .pro files"
    echo ""
    echo "  refresh-tags"
    echo "      Refresh artist tags from MusicBrainz (requires local MB database)"
    echo "      and rebuild the index"
    echo ""
    echo "  sync-tag-votes"
    echo "      Sync tag overrides from trusted user votes in Supabase"
    echo "      (requires SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY env vars)"
    echo ""
    echo "  sync-deleted-songs"
    echo "      Sync deleted songs list from Supabase"
    echo "      (requires SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY env vars)"
    echo ""
    echo "  fetch-tune <name>"
    echo "      Fetch a single tune from TuneArch by name and rebuild the index"
    echo ""
    echo "  bulk-fetch-tunes [limit]"
    echo "      Fetch multiple tunes from TuneArch curated list (default: 10)"
    echo ""
    echo "  search-tunes <query> [limit]"
    echo "      Search TuneArch for tunes matching query and fetch results"
    echo ""
    echo "  export-suggestions"
    echo "      Export user genre suggestions from Supabase to JSON"
    echo "      (requires SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY env vars)"
    echo ""
    echo "  build-posts"
    echo "      Build posts.json manifest from markdown files in docs/posts/"
    echo ""
    echo "  loc [path]"
    echo "      Count lines of code by language"
    echo ""
    echo "  strum-machine-test <song title>"
    echo "      Test Strum Machine API match for a single song"
    echo ""
    echo "  strum-machine-match"
    echo "      Batch match all songs against Strum Machine and cache results"
    echo "      (requires STRUM_MACHINE_API_KEY env var)"
    echo ""
    echo "  search <query>"
    echo "      Search the song index from command line"
    echo "      Examples:"
    echo "        ./scripts/utility search \"artist:bill monroe prog:I-IV-V\""
    echo "        ./scripts/utility search \"tag:bluegrass tag:jamfriendly\""
    echo "        ./scripts/utility search \"artist:ralph stanley key:G\""
    echo ""
    echo "  banjo-scan [--limit N] [--letter L] [--priority] [--max-priority N]"
    echo "      Scan Banjo Hangout for available tabs"
    echo "      --priority: Only scan for tabs matching our priority list"
    echo "      --max-priority N: Max tier (1-5=essential, 6-10=common, default: 5)"
    echo ""
    echo "  banjo-download [--limit N]"
    echo "      Download TEF files from Banjo Hangout"
    echo ""
    echo "  banjo-convert [--limit N]"
    echo "      Convert downloaded TEF files to OTF format"
    echo ""
    echo "  banjo-import [--limit N] [--dry-run]"
    echo "      Import converted tabs to works/ directory"
    echo ""
    echo "  banjo-stats"
    echo "      Show Banjo Hangout catalog statistics"
    echo ""
    echo "  banjo-priorities"
    echo "      Show priority list statistics (tune list + works)"
    echo ""
    echo "  banjo-convert-file <tef_path> [output_path]"
    echo "      Convert a single TEF file to OTF (standalone, no catalog)"
    echo ""
}

case "$COMMAND" in
    add-song)
        uv run python3 scripts/lib/add_song.py "$@"
        ;;
    add-placeholder)
        if [ -z "$1" ]; then
            echo "Error: song title required"
            echo "Usage: ./scripts/utility add-placeholder \"Song Title\" [--artist NAME] [--key KEY]"
            exit 1
        fi
        uv run python3 scripts/lib/add_placeholder.py "$@"
        ;;
    count-chords)
        uv run python3 scripts/lib/chord_counter.py "$@"
        ;;
    refresh-tags)
        echo "Refreshing artist tags from MusicBrainz..."
        MB_PORT=5440 uv run python3 scripts/lib/query_artist_tags.py --refresh
        echo ""
        echo "Rebuilding index with updated tags..."
        uv run python3 scripts/lib/build_index.py
        echo ""
        echo "Done! Tags refreshed and index rebuilt."
        ;;
    sync-tag-votes)
        echo "Fetching tag overrides from trusted user votes..."
        uv run python3 scripts/lib/fetch_tag_overrides.py
        echo ""
        echo "Rebuilding index..."
        ./scripts/bootstrap --quick
        echo ""
        echo "Done! Tag overrides synced and index rebuilt."
        ;;
    sync-deleted-songs)
        echo "Fetching deleted songs list from Supabase..."
        uv run python3 scripts/lib/fetch_deleted_songs.py
        echo ""
        echo "Rebuilding index..."
        ./scripts/bootstrap --quick
        echo ""
        echo "Done! Deleted songs synced and index rebuilt."
        ;;
    fetch-tune)
        if [ -z "$1" ]; then
            echo "Error: tune name required"
            echo "Usage: ./scripts/utility fetch-tune \"Tune Name\""
            exit 1
        fi
        echo "Fetching tune: $1"
        uv run python3 sources/tunearch/src/batch_fetch.py --tune "$1"
        echo ""
        echo "Rebuilding index..."
        uv run python3 scripts/lib/build_index.py --no-tags
        echo ""
        echo "Done! Tune fetched and index rebuilt."
        ;;
    bulk-fetch-tunes)
        LIMIT="${1:-10}"
        echo "Fetching up to $LIMIT tunes from TuneArch..."
        uv run python3 sources/tunearch/src/batch_fetch.py --limit "$LIMIT"
        echo ""
        echo "Rebuilding index..."
        uv run python3 scripts/lib/build_index.py --no-tags
        echo ""
        echo "Done! Tunes fetched and index rebuilt."
        ;;
    search-tunes)
        if [ -z "$1" ]; then
            echo "Error: search query required"
            echo "Usage: ./scripts/utility search-tunes \"query\" [limit]"
            exit 1
        fi
        QUERY="$1"
        LIMIT="${2:-10}"
        echo "Searching TuneArch for: $QUERY"
        uv run python3 sources/tunearch/src/batch_fetch.py --search "$QUERY" --limit "$LIMIT"
        echo ""
        echo "Rebuilding index..."
        uv run python3 scripts/lib/build_index.py --no-tags
        echo ""
        echo "Done! Tunes fetched and index rebuilt."
        ;;
    export-suggestions)
        echo "Exporting genre suggestions from Supabase..."
        uv run python3 scripts/lib/export_genre_suggestions.py
        ;;
    build-posts)
        echo "Building posts manifest..."
        uv run python3 scripts/lib/build_posts.py
        ;;
    loc)
        uv run python3 scripts/lib/loc_counter.py "$@"
        ;;
    strum-machine-test)
        if [ -z "$1" ]; then
            echo "Error: song title required"
            echo "Usage: ./scripts/utility strum-machine-test \"Song Title\""
            exit 1
        fi
        uv run python3 -m scripts.lib.strum_machine "$@"
        ;;
    strum-machine-match)
        echo "Matching all songs against Strum Machine..."
        echo "(This will take ~30 minutes for 17k songs at 10 req/sec)"
        echo ""
        uv run python3 -m scripts.lib.strum_machine --batch
        ;;
    search)
        if [ -z "$1" ]; then
            echo "Error: search query required"
            echo "Usage: ./scripts/utility search \"query\""
            echo ""
            echo "Examples:"
            echo "  ./scripts/utility search \"artist:bill monroe prog:I-IV-V\""
            echo "  ./scripts/utility search \"tag:bluegrass tag:jamfriendly -tag:classiccountry\""
            echo "  ./scripts/utility search \"artist:ralph stanley key:G\""
            exit 1
        fi
        uv run python3 scripts/lib/search_index.py "$@"
        ;;
    banjo-scan)
        echo "Scanning Banjo Hangout for tabs..."
        uv run python3 sources/banjo-hangout/src/batch_import.py scan "$@"
        ;;
    banjo-download)
        echo "Downloading TEF files from Banjo Hangout..."
        uv run python3 sources/banjo-hangout/src/batch_import.py download "$@"
        ;;
    banjo-convert)
        echo "Converting TEF files to OTF format..."
        uv run python3 sources/banjo-hangout/src/batch_import.py convert "$@"
        ;;
    banjo-import)
        echo "Importing tabs to works/ directory..."
        uv run python3 sources/banjo-hangout/src/batch_import.py import "$@"
        echo ""
        echo "Rebuilding index..."
        uv run python3 scripts/lib/build_works_index.py
        echo ""
        echo "Done!"
        ;;
    banjo-stats)
        uv run python3 sources/banjo-hangout/src/batch_import.py stats
        ;;
    banjo-priorities)
        uv run python3 sources/banjo-hangout/src/batch_import.py priorities
        ;;
    banjo-convert-file)
        if [ -z "$1" ]; then
            echo "Error: TEF file path required"
            echo "Usage: ./scripts/utility banjo-convert-file <tef_path> [output_path]"
            exit 1
        fi
        uv run python3 sources/banjo-hangout/src/batch_import.py convert-file "$@"
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        echo "Unknown command: $COMMAND"
        echo ""
        show_help
        exit 1
        ;;
esac
