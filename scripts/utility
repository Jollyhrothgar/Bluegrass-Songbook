#!/usr/bin/env bash
#
# utility - User-facing utility commands
#
# Usage:
#   ./scripts/utility add-song /path/to/song.pro [--skip-index-rebuild]
#   ./scripts/utility count-chords [path]
#

set -e

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
cd "$REPO_ROOT"

COMMAND="${1:-}"
shift 2>/dev/null || true

show_help() {
    echo "Usage: ./scripts/utility <command> [options]"
    echo ""
    echo "Commands:"
    echo "  add-song <file.pro> [--skip-index-rebuild]"
    echo "      Add a song to the manual collection and rebuild the index"
    echo ""
    echo "  count-chords [path]"
    echo "      Count chord usage in .pro files"
    echo ""
    echo "  refresh-tags"
    echo "      Refresh artist tags from MusicBrainz (requires local MB database)"
    echo "      and rebuild the index"
    echo ""
    echo "  fetch-tune <name>"
    echo "      Fetch a single tune from TuneArch by name and rebuild the index"
    echo ""
    echo "  bulk-fetch-tunes [limit]"
    echo "      Fetch multiple tunes from TuneArch curated list (default: 10)"
    echo ""
    echo "  search-tunes <query> [limit]"
    echo "      Search TuneArch for tunes matching query and fetch results"
    echo ""
    echo "  export-suggestions"
    echo "      Export user genre suggestions from Supabase to JSON"
    echo "      (requires SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY env vars)"
    echo ""
    echo "  build-posts"
    echo "      Build posts.json manifest from markdown files in docs/posts/"
    echo ""
    echo "  strum-machine-test <song title>"
    echo "      Test Strum Machine API match for a single song"
    echo ""
    echo "  strum-machine-match"
    echo "      Batch match all songs against Strum Machine and cache results"
    echo "      (requires STRUM_MACHINE_API_KEY env var)"
    echo ""
}

case "$COMMAND" in
    add-song)
        uv run python3 scripts/lib/add_song.py "$@"
        ;;
    count-chords)
        uv run python3 scripts/lib/chord_counter.py "$@"
        ;;
    refresh-tags)
        echo "Refreshing artist tags from MusicBrainz..."
        MB_PORT=5440 uv run python3 scripts/lib/query_artist_tags.py --refresh
        echo ""
        echo "Rebuilding index with updated tags..."
        uv run python3 scripts/lib/build_index.py
        echo ""
        echo "Done! Tags refreshed and index rebuilt."
        ;;
    fetch-tune)
        if [ -z "$1" ]; then
            echo "Error: tune name required"
            echo "Usage: ./scripts/utility fetch-tune \"Tune Name\""
            exit 1
        fi
        echo "Fetching tune: $1"
        uv run python3 sources/tunearch/src/batch_fetch.py --tune "$1"
        echo ""
        echo "Rebuilding index..."
        uv run python3 scripts/lib/build_index.py --no-tags
        echo ""
        echo "Done! Tune fetched and index rebuilt."
        ;;
    bulk-fetch-tunes)
        LIMIT="${1:-10}"
        echo "Fetching up to $LIMIT tunes from TuneArch..."
        uv run python3 sources/tunearch/src/batch_fetch.py --limit "$LIMIT"
        echo ""
        echo "Rebuilding index..."
        uv run python3 scripts/lib/build_index.py --no-tags
        echo ""
        echo "Done! Tunes fetched and index rebuilt."
        ;;
    search-tunes)
        if [ -z "$1" ]; then
            echo "Error: search query required"
            echo "Usage: ./scripts/utility search-tunes \"query\" [limit]"
            exit 1
        fi
        QUERY="$1"
        LIMIT="${2:-10}"
        echo "Searching TuneArch for: $QUERY"
        uv run python3 sources/tunearch/src/batch_fetch.py --search "$QUERY" --limit "$LIMIT"
        echo ""
        echo "Rebuilding index..."
        uv run python3 scripts/lib/build_index.py --no-tags
        echo ""
        echo "Done! Tunes fetched and index rebuilt."
        ;;
    export-suggestions)
        echo "Exporting genre suggestions from Supabase..."
        uv run python3 scripts/lib/export_genre_suggestions.py
        ;;
    build-posts)
        echo "Building posts manifest..."
        uv run python3 scripts/lib/build_posts.py
        ;;
    strum-machine-test)
        if [ -z "$1" ]; then
            echo "Error: song title required"
            echo "Usage: ./scripts/utility strum-machine-test \"Song Title\""
            exit 1
        fi
        uv run python3 -m scripts.lib.strum_machine "$@"
        ;;
    strum-machine-match)
        echo "Matching all songs against Strum Machine..."
        echo "(This will take ~30 minutes for 17k songs at 10 req/sec)"
        echo ""
        uv run python3 -m scripts.lib.strum_machine --batch
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        echo "Unknown command: $COMMAND"
        echo ""
        show_help
        exit 1
        ;;
esac
